# 2025-12-06 (Phase 2) - 프레임워크 개선 계획

> docs/ 폴더의 초기 계획 문서들을 참고하여 작성한 개선 로드맵

## 현재 상태 평가 ✅

### 달성한 목표 (Phase 1 완료)
- [x] **Port-Adapter 분리**: `app/core/ports/`, `app/core/adapters/` 구조 완성
- [x] **Module.py 템플릿화**: `app/cooking_assistant/module.py`로 DI 설정 분리
- [x] **Pure Adapter 원칙**: 비즈니스 로직 없는 깔끔한 Adapter 구현
- [x] **Secondary Intent 처리**: `processed_secondary_intents` 추적 시스템 완성
- [x] **Prompts 템플릿별 관리**: `app/cooking_assistant/prompts/`

### 미달성 항목 (docs/TODO.md 참고)
- [ ] JWT 인증 테스트 (구현은 완료, 테스트 필요)
- [ ] RAG (Vector Store) 통합
- [ ] Conversation Memory 통합
- [ ] 프롬프트 A/B 테스트 시스템
- [ ] 프레임워크화 (CLI, 스캐폴딩)

---

## 개선 과제 📋

### 1. 핵심 기능 강화

#### 1.1 프롬프트 관리 시스템 고도화
**현재 상태**:
- YAML + Jinja2 기본 구조만 있음
- 버전 관리 없음
- A/B 테스트 불가

**개선 방향** (docs/framework.md 참고):
```yaml
# prompts/config.yaml
prompts:
  intent_classification:
    template: intent_classification.j2
    version: "2.0"
    model: claude-sonnet-4-5-20250929
    temperature: 0.3

    # A/B 테스트
    ab_test:
      enabled: true
      variants:
        - name: control
          weight: 0.5
          template: intent_classification.j2
        - name: experimental
          weight: 0.5
          template: intent_classification_v2.j2

    # 다국어
    localization:
      enabled: true
      default_locale: ko
      fallback_locale: en
```

**작업 항목**:
- [ ] `app/core/prompt_loader.py`에 버전 관리 추가
- [ ] A/B 테스트 기능 구현
- [ ] 다국어 지원 (ko/en 폴더 구조)
- [ ] 프롬프트 변경 시 핫 리로드

#### 1.2 RAG (Vector Store) 통합
**목표** (docs/TODO.md 라인 622-763 참고):
- 유사 레시피 검색으로 컨텍스트 제공
- 생성된 레시피를 자동으로 Vector DB에 저장

**작업 항목**:
- [ ] `app/core/ports/vector_store_port.py` 생성
  ```python
  class IVectorStorePort(ABC):
      async def search(self, query: str, top_k: int) -> List[Document]
      async def add_documents(self, documents: List[Document]) -> None
      async def delete_by_metadata(self, filter: dict) -> int
  ```
- [ ] `app/core/adapters/vector_store/chroma_adapter.py` 구현
- [ ] RAG 노드 추가: `app/cooking_assistant/workflow/nodes/rag_recipe_generator_node.py`
- [ ] 의존성 추가: `chromadb`, `sentence-transformers`

#### 1.3 Conversation Memory 통합
**목표** (docs/TODO.md 라인 767-916):
- 대화 히스토리 저장/조회
- 멀티턴 대화 지원
- 세션 관리

**작업 항목**:
- [ ] `app/core/ports/memory_port.py` 생성
  ```python
  class IConversationMemory(ABC):
      async def get_history(self, session_id: str, limit: int) -> List[Message]
      async def save_message(self, session_id: str, message: Message) -> None
      async def clear_history(self, session_id: str) -> None
  ```
- [ ] `app/core/adapters/memory/postgres_memory_adapter.py` 구현
- [ ] `app/core/adapters/memory/redis_memory_adapter.py` 구현 (캐시용)
- [ ] Context-aware 노드 추가

---

### 2. 개발자 경험 개선

#### 2.1 설정 기반 개발 (docs/framework.md 라인 530-829)
**현재**: 코드로 직접 설정
**목표**: YAML 중앙 설정으로 코드 최소화

**작업 항목**:
- [ ] `config/settings.yaml` 메인 설정 파일 생성
  ```yaml
  application:
    name: cooking-assistant
    version: "1.0.0"

  llm:
    provider: anthropic
    config:
      model: claude-sonnet-4-5-20250929
      temperature: 0.7

  vector_store:
    provider: chroma
    config:
      collection_name: recipes

  memory:
    provider: postgres
    config:
      database_url: ${DATABASE_URL}
  ```
- [ ] `config/settings.dev.yaml`, `config/settings.prod.yaml` 환경별 분리
- [ ] 환경 자동 감지 및 오버라이드 로직

#### 2.2 테스트 인프라 구축
**작업 항목**:
- [ ] Mock Adapter 자동 생성 도구
- [ ] `tests/adapters/` 단위 테스트 추가
- [ ] `tests/workflows/` 통합 테스트 추가
- [ ] JWT 인증 테스트 (docs/TODO.md 라인 1047)
- [ ] CI/CD 파이프라인 (GitHub Actions)

#### 2.3 로깅 및 모니터링
**작업 항목**:
- [ ] 구조화된 로깅 (`structlog`)
- [ ] 메트릭 수집 (Prometheus 연동 준비)
- [ ] 노드 실행 시간 추적
- [ ] LLM API 호출 비용 추적

---

### 3. 프레임워크화 준비

#### 3.1 Core 추출
**목표**: `app/core/`를 독립 패키지로 분리 가능하도록

**작업 항목**:
- [ ] BasePort, BaseAdapter, BaseNode 추상 클래스 정의
- [ ] PromptLoader를 독립 모듈로
- [ ] DI Container 범용화 (decorators.py 개선)
- [ ] 설정 시스템 범용화

#### 3.2 CLI 도구 (향후 프레임워크 배포 시)
**목표** (docs/framework.md 라인 832-889):
```bash
# 프로젝트 생성
$ pyai create my-bot --template=chatbot

# Adapter 생성
$ pyai generate adapter --type=llm --name=GeminiLLM

# 프롬프트 검증
$ pyai validate-prompts

# 실행
$ pyai run --reload
```

**작업 항목** (현재는 스킵, 추후 검토):
- [ ] 프로젝트 스캐폴딩 로직
- [ ] 코드 생성기 (Jinja2 템플릿)
- [ ] 프롬프트 검증 도구

---

### 4. 문서화

#### 4.1 README.md 보완
- [x] 프로젝트 구조 다이어그램 업데이트 (완료)
- [x] Pure Adapter 원칙 설명 강화 (완료)
- [ ] RAG 사용 예시 추가
- [ ] Conversation Memory 사용 예시 추가

#### 4.2 개발자 가이드 작성
**작업 항목**:
- [ ] `docs/DEVELOPMENT.md`: 로컬 개발 가이드
- [ ] `docs/ARCHITECTURE.md`: 아키텍처 상세 설명
- [ ] `docs/TESTING.md`: 테스트 작성 가이드
- [ ] `docs/DEPLOYMENT.md`: 배포 가이드

#### 4.3 API 문서 자동화
- [ ] OpenAPI 스펙 자동 생성 (FastAPI 기본 기능)
- [ ] Swagger UI 커스터마이징
- [ ] 예제 요청/응답 추가

---

## 우선순위 (3단계) 🎯

### P0 (즉시): 핵심 기능 안정화
1. JWT 인증 테스트 작성 및 검증
2. 에러 핸들링 개선 (현재 누락된 케이스 보완)
3. 로깅 시스템 구축 (디버깅 용이성)

### P1 (1-2주): 기능 확장
4. 프롬프트 관리 시스템 고도화 (A/B 테스트, 다국어)
5. RAG 통합 (Vector Store Port + Chroma Adapter)
6. 테스트 인프라 구축

### P2 (1개월): 프레임워크화 준비
7. Conversation Memory 통합
8. 설정 기반 개발 (YAML 중앙화)
9. Core 추출 및 범용화
10. 문서화 완성

---

## 기술 부채 정리 🔧

### 코드 품질
- [ ] Type hints 100% 커버리지 (현재 ~80%)
- [ ] Docstring 추가 (주요 클래스/메서드)
- [ ] `mypy` 정적 타입 검사 통과
- [ ] `ruff` 린터 규칙 통과

### 성능 최적화
- [ ] LLM API 호출 캐싱 (Redis)
- [ ] Prompt 렌더링 캐싱
- [ ] Vector DB 배치 처리
- [ ] 비동기 처리 개선 (현재 일부만 async)

### 보안
- [ ] 환경 변수 검증 강화
- [ ] API Rate Limiting
- [ ] Input Validation 강화
- [ ] SQL Injection 방지 (Memory Adapter)

---

## 참고 문서 링크 📚

### 초기 계획 문서
- **초기 계획**: [docs/TODO.md](../docs/TODO.md) - UseCase DTO 반환 패턴, 인증, RAG, Memory
- **프레임워크 비전**: [docs/framework.md](../docs/framework.md) - PyAI Framework 전체 구상
- **아키텍처 요약**: [docs/summary.md](../docs/summary.md) - 핵심 원칙 정리

### 단계별 구현 가이드 (Phase 2-5)
- **Phase 2**: [docs/PHASE2.md](../docs/PHASE2.md) - 인증 및 테스트 인프라 구축
  - JWT 인증 테스트 작성
  - 에러 핸들링 개선
  - 로깅 시스템 (structlog)
  - 테스트 인프라 (pytest, GitHub Actions)

- **Phase 3**: [docs/PHASE3.md](../docs/PHASE3.md) - RAG (Vector Store) 통합
  - IVectorStorePort 인터페이스
  - ChromaDB Adapter 구현
  - RAG Recipe Generator Node
  - 유사 레시피 검색 및 컨텍스트 활용

- **Phase 4**: [docs/PHASE4.md](../docs/PHASE4.md) - Conversation Memory 통합
  - IConversationMemory 인터페이스
  - PostgreSQL/Redis Memory Adapter
  - Context-Aware Recipe Node
  - 멀티턴 대화 지원

- **Phase 5**: [docs/PHASE5.md](../docs/PHASE5.md) - 프레임워크화 (PyAI Framework)
  - Core 추출 및 범용화
  - CLI 도구 (pyai create, generate, validate)
  - 템플릿 시스템 (chatbot, rag_qa)
  - PyPI 패키징 및 배포

---

## 메모 📝

### 현재 상태 평가
- **Phase 1 (기본 아키텍처)**: 100% 완료 ✅
- **Phase 2 (인증)**: 95% 완료 (테스트만 남음)
- **Phase 3 (RAG)**: 0% (설계만 문서화됨)
- **Phase 4 (Memory)**: 0% (설계만 문서화됨)
- **Phase 5 (프레임워크화)**: 0% (향후 과제)

### 다음 세션 목표
1. JWT 인증 테스트 작성 (30분)
2. 로깅 시스템 구축 (1시간)
3. 프롬프트 버전 관리 기능 추가 (1-2시간)
